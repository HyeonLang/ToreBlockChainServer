# 2025-11-11 마켓플레이스 통합 업데이트

## 개요
- `MarketplaceVault.sol` 신규 설계 및 배포 준비로 NFT/토큰 자산 관리 로직 정비
- 블록체인 리스너와 메인 서버 간 데이터 파이프라인을 정형화하여 이벤트 기반 처리 안정화
- 환경 변수와 API 명세를 최신 상태로 재정리해 운영/테스트 환경 일관성 확보

## 스마트 컨트랙트
- `blockchain/contracts/MarketplaceVault.sol` 초안 작성
  - 입금/출금, 관리자 승인, 락업 기간 검증 로직을 Solidity 0.8 기반으로 구현
  - 재진입 방지, Ownable 권한 제어, 이벤트 로깅 추가
  - 테스트 스크립트(`blockchain/scripts/testVault.ts`, `blockchain/scripts/testVaultOnFuji.ts`)를 통해 로컬·Fuji 네트워크 시뮬레이션
- 배포 스크립트(`blockchain/scripts/deployVault.ts`)를 `MarketplaceVault` 대응으로 보완, 실제 배포 파이프라인 점검

## 백엔드 플로우
- `backend/src/services/blockchainListener.service.ts`
  - 새 Vault 이벤트(예: `Locked`, `Unlocked`, `Withdrawn`) 구독 및 이벤트 큐 전송 로직 추가
  - 에러 핸들링·재시도 정책을 BullMQ 기반으로 강화하여 누락 방지
- `backend/src/services/blockchainWorker.service.ts`
  - 리스너가 큐에 넣은 작업 소비, 메인 서버 비즈니스 로직 호출 경로 확립
  - 이벤트 별 데이터 정규화, 중복 처리 방지 캐싱(Redis) 연동
- `backend/src/app.ts`
  - 워커/리스너 초기화 순서 정리, 종료 시 안전한 자원 해제 로직 보완

## 환경 구성
- `env`/`.env.example`
  - `BLOCKCHAIN_RPC_URL`, `MARKETPLACE_VAULT_ADDRESS`, `REDIS_URL` 등 신규 필수 변수 추가
  - 큐 명칭·동시성 설정(`BLOCKCHAIN_QUEUE_NAME`, `WORKER_CONCURRENCY`) 문서화
  - 개발/스테이징 값 예시 업데이트, 보안 민감 항목 주석으로 안내

## API 업데이트
- `backend/src/routes/nft.ts`, `backend/src/controllers/nftController.ts`
  - Vault 연동을 고려한 NFT 락업/해제 엔드포인트 확장
  - 입력 검증 미들웨어 정비, Vault 이벤트 기반 상태 필드 반환
- Postman 컬렉션(`postman_collections/NFT_API_Collection.json`) 갱신
  - 신규 엔드포인트, 예시 요청/응답 추가
  - QA 시나리오(락업→해제→출금) 문서화

## 기타 메모
- Redis 설정(`backend/src/config/redis.config.ts`)에서 지수 백오프·타임아웃 기본값 재조정
- `README.md`/내부 문서 보완: 배포 전 체크리스트 및 Vault 운영 주의사항 추가
- 남은 과제: Fuji 네트워크 실거래 테스트, 모니터링 대시보드 알람 연동, 컨트랙트 감사 대응 준비

