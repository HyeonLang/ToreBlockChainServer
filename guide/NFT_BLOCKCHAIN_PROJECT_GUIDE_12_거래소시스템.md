# NFT ë¸”ë¡ì²´ì¸ í”„ë¡œì íŠ¸ ì™„ì „ ê°€ì´ë“œ - 12í¸: NFT-TORE ê±°ë˜ì†Œ ì‹œìŠ¤í…œ

## ğŸ“š ëª©ì°¨
1. [ê±°ë˜ì†Œ ì‹œìŠ¤í…œ ê°œìš”](#ê±°ë˜ì†Œ-ì‹œìŠ¤í…œ-ê°œìš”)
2. [ToreExchange ì»¨íŠ¸ë™íŠ¸ ë¶„ì„](#toreexchange-ì»¨íŠ¸ë™íŠ¸-ë¶„ì„)
3. [ê±°ë˜ êµ¬ì¡°ì²´ì™€ ìƒíƒœ ê´€ë¦¬](#ê±°ë˜-êµ¬ì¡°ì²´ì™€-ìƒíƒœ-ê´€ë¦¬)
4. [ê±°ë˜ ìƒì„± ë° ê´€ë¦¬](#ê±°ë˜-ìƒì„±-ë°-ê´€ë¦¬)
5. [NFT êµ¬ë§¤ ë° ê²°ì œ](#nft-êµ¬ë§¤-ë°-ê²°ì œ)
6. [ê±°ë˜ ì·¨ì†Œ ë° ê´€ë¦¬](#ê±°ë˜-ì·¨ì†Œ-ë°-ê´€ë¦¬)
7. [ìˆ˜ìˆ˜ë£Œ ì‹œìŠ¤í…œ](#ìˆ˜ìˆ˜ë£Œ-ì‹œìŠ¤í…œ)
8. [ë°±ì—”ë“œ API êµ¬í˜„](#ë°±ì—”ë“œ-api-êµ¬í˜„)
9. [í”„ë¡ íŠ¸ì—”ë“œ í†µí•©](#í”„ë¡ íŠ¸ì—”ë“œ-í†µí•©)
10. [ë³´ì•ˆ ë° ìµœì í™”](#ë³´ì•ˆ-ë°-ìµœì í™”)

---

## ğŸª ê±°ë˜ì†Œ ì‹œìŠ¤í…œ ê°œìš”

### ê±°ë˜ì†Œë€?

**NFT-TORE ê±°ë˜ì†Œ**ëŠ” NFTë¥¼ TORE í† í°ìœ¼ë¡œ íŒë§¤í•˜ê³  êµ¬ë§¤í•  ìˆ˜ ìˆëŠ” ì¤‘ì•™í™”ëœ ê±°ë˜ í”Œë«í¼ì…ë‹ˆë‹¤.

**ì£¼ìš” ê¸°ëŠ¥:**
- **NFT íŒë§¤**: ì†Œìœ ìê°€ NFTë¥¼ TORE í† í°ìœ¼ë¡œ íŒë§¤ ë“±ë¡
- **NFT êµ¬ë§¤**: êµ¬ë§¤ìê°€ TORE í† í°ìœ¼ë¡œ NFT êµ¬ë§¤
- **ê±°ë˜ ê´€ë¦¬**: ê±°ë˜ ìƒì„±, ì§„í–‰, ì™„ë£Œ, ì·¨ì†Œ ê´€ë¦¬
- **ìˆ˜ìˆ˜ë£Œ ì‹œìŠ¤í…œ**: ê±°ë˜ ìˆ˜ìˆ˜ë£Œ ìë™ ì°¨ê° ë° ê´€ë¦¬
- **ê±°ë˜ ë‚´ì—­**: ëª¨ë“  ê±°ë˜ ê¸°ë¡ ë¸”ë¡ì²´ì¸ì— ì €ì¥

### ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ì›¹ ë¸Œë¼ìš°ì €    â”‚    â”‚   Express ì„œë²„   â”‚    â”‚  Avalanche ë¸”ë¡ì²´ì¸ â”‚
â”‚   (ê±°ë˜ì†Œ UI)   â”‚â—„â”€â”€â–ºâ”‚   (ê±°ë˜ì†Œ API)  â”‚â—„â”€â”€â–ºâ”‚   (ê±°ë˜ì†Œ ì»¨íŠ¸ë™íŠ¸) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ MetaMaskâ”‚            â”‚ ê±°ë˜ì†Œ APIâ”‚            â”‚ToreExchangeâ”‚
    â”‚  ì§€ê°‘   â”‚            â”‚ ì»¨íŠ¸ë¡¤ëŸ¬â”‚            â”‚ ì»¨íŠ¸ë™íŠ¸â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ TOREí† í°â”‚            â”‚ NFT API â”‚            â”‚GameItem â”‚
    â”‚ ì»¨íŠ¸ë™íŠ¸â”‚            â”‚ ì»¨íŠ¸ë¡¤ëŸ¬â”‚            â”‚ ì»¨íŠ¸ë™íŠ¸â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ê±°ë˜ íë¦„

```
1. íŒë§¤ì: NFTë¥¼ ê±°ë˜ì†Œì— íŒë§¤ ë“±ë¡
2. êµ¬ë§¤ì: ê±°ë˜ì†Œì—ì„œ NFT ê²€ìƒ‰ ë° êµ¬ë§¤ ìš”ì²­
3. ê±°ë˜ì†Œ: TORE í† í° ì”ì•¡ í™•ì¸ ë° ì „ì†¡
4. ê±°ë˜ì†Œ: NFT ì†Œìœ ê¶Œ ì´ì „
5. ê±°ë˜ì†Œ: ìˆ˜ìˆ˜ë£Œ ì°¨ê° ë° ì •ì‚°
6. ê±°ë˜ ì™„ë£Œ: ê±°ë˜ ë‚´ì—­ ë¸”ë¡ì²´ì¸ì— ê¸°ë¡
```

---

## ğŸ”§ ToreExchange ì»¨íŠ¸ë™íŠ¸ ë¶„ì„

### ì „ì²´ êµ¬ì¡°

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC721/IERC721.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract ToreExchange is Ownable, ReentrancyGuard {
    IERC721 public nftContract;
    IERC20 public toreTokenContract;
    
    struct Trade {
        address seller;
        address buyer;
        uint256 tokenId;
        uint256 price;
        bool isActive;
        uint256 createdAt;
        uint256 completedAt;
    }
    
    uint256 public feePercentage = 250; // 2.5%
    uint256 public constant FEE_DENOMINATOR = 10000;
    
    mapping(uint256 => Trade) public trades;
    mapping(address => uint256[]) public userTrades;
    
    uint256 private _tradeIdCounter = 1;
}
```

### ìƒì† êµ¬ì¡°

```
ToreExchange
â”œâ”€â”€ Ownable (ì†Œìœ ì ê¶Œí•œ ê´€ë¦¬)
â””â”€â”€ ReentrancyGuard (ì¬ì§„ì… ê³µê²© ë°©ì§€)
```

**ìƒì†ì˜ ì¥ì :**
- **Ownable**: ì†Œìœ ìë§Œ ìˆ˜ìˆ˜ë£Œ ë³€ê²½, ì»¨íŠ¸ë™íŠ¸ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
- **ReentrancyGuard**: ì¬ì§„ì… ê³µê²©ìœ¼ë¡œë¶€í„° ì•ˆì „í•œ ê±°ë˜ ë³´ì¥

### ìƒíƒœ ë³€ìˆ˜

```solidity
IERC721 public nftContract;           // NFT ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ
IERC20 public toreTokenContract;      // TORE í† í° ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ

uint256 public feePercentage = 250;   // ê±°ë˜ ìˆ˜ìˆ˜ë£Œ (2.5%)
uint256 public constant FEE_DENOMINATOR = 10000;  // ìˆ˜ìˆ˜ë£Œ ê³„ì‚° ê¸°ì¤€

mapping(uint256 => Trade) public trades;           // ê±°ë˜ ì •ë³´
mapping(address => uint256[]) public userTrades;   // ì‚¬ìš©ìë³„ ê±°ë˜ ëª©ë¡

uint256 private _tradeIdCounter = 1;  // ê±°ë˜ ID ì¹´ìš´í„°
```

---

## ğŸ“Š ê±°ë˜ êµ¬ì¡°ì²´ì™€ ìƒíƒœ ê´€ë¦¬

### Trade êµ¬ì¡°ì²´

```solidity
struct Trade {
    address seller;      // íŒë§¤ì ì£¼ì†Œ
    address buyer;       // êµ¬ë§¤ì ì£¼ì†Œ (ê±°ë˜ ì™„ë£Œ ì‹œ)
    uint256 tokenId;     // NFT í† í° ID
    uint256 price;        // íŒë§¤ ê°€ê²© (TORE í† í°)
    bool isActive;        // ê±°ë˜ í™œì„± ìƒíƒœ
    uint256 createdAt;    // ê±°ë˜ ìƒì„± ì‹œê°„
    uint256 completedAt;  // ê±°ë˜ ì™„ë£Œ ì‹œê°„
}
```

### ê±°ë˜ ìƒíƒœ ê´€ë¦¬

```solidity
// ê±°ë˜ ìƒì„±
trades[tradeId] = Trade({
    seller: msg.sender,
    buyer: address(0),        // ì•„ì§ êµ¬ë§¤ì ì—†ìŒ
    tokenId: tokenId,
    price: price,
    isActive: true,           // í™œì„± ìƒíƒœ
    createdAt: block.timestamp,
    completedAt: 0            // ì•„ì§ ì™„ë£Œë˜ì§€ ì•ŠìŒ
});

// ê±°ë˜ ì™„ë£Œ
trades[tradeId].isActive = false;
trades[tradeId].buyer = msg.sender;
trades[tradeId].completedAt = block.timestamp;
```

### ê±°ë˜ ID ê´€ë¦¬

```solidity
uint256 private _tradeIdCounter = 1;

function getNextTradeId() internal returns (uint256) {
    return _tradeIdCounter++;
}
```

**ê±°ë˜ ID íŠ¹ì§•:**
- **ê³ ìœ ì„±**: 1ë¶€í„° ì‹œì‘í•˜ì—¬ ìë™ ì¦ê°€
- **ìˆœì°¨ì„±**: ì‹œê°„ ìˆœì„œëŒ€ë¡œ ìƒì„±
- **ë¶ˆë³€ì„±**: í•œë²ˆ í• ë‹¹ëœ IDëŠ” ë³€ê²½ë˜ì§€ ì•ŠìŒ

---

## ğŸ›’ ê±°ë˜ ìƒì„± ë° ê´€ë¦¬

### ê±°ë˜ ìƒì„± (createTrade)

```solidity
function createTrade(uint256 tokenId, uint256 price) external nonReentrant {
    require(price > 0, "ToreExchange: Price must be greater than 0");
    require(nftContract.ownerOf(tokenId) == msg.sender, "ToreExchange: Not the owner of this NFT");
    require(nftContract.getApproved(tokenId) == address(this) || 
            nftContract.isApprovedForAll(msg.sender, address(this)), 
            "ToreExchange: Contract not approved to transfer NFT");
    
    uint256 tradeId = _tradeIdCounter++;
    trades[tradeId] = Trade({
        seller: msg.sender,
        buyer: address(0),
        tokenId: tokenId,
        price: price,
        isActive: true,
        createdAt: block.timestamp,
        completedAt: 0
    });
    
    userTrades[msg.sender].push(tradeId);
    
    emit TradeCreated(tradeId, msg.sender, tokenId, price);
}
```

**ì‹¤í–‰ íë¦„:**
1. **ì…ë ¥ ê²€ì¦**: ê°€ê²©ì´ 0ë³´ë‹¤ í°ì§€ í™•ì¸
2. **ì†Œìœ ê¶Œ í™•ì¸**: í˜¸ì¶œìê°€ NFT ì†Œìœ ìì¸ì§€ í™•ì¸
3. **ìŠ¹ì¸ í™•ì¸**: ì»¨íŠ¸ë™íŠ¸ê°€ NFTë¥¼ ì „ì†¡í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
4. **ê±°ë˜ ìƒì„±**: ìƒˆë¡œìš´ ê±°ë˜ ì •ë³´ ì €ì¥
5. **ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸**: íŒë§¤ìì˜ ê±°ë˜ ëª©ë¡ì— ì¶”ê°€
6. **ì´ë²¤íŠ¸ ë°œìƒ**: ê±°ë˜ ìƒì„± ì´ë²¤íŠ¸ ë°œìƒ

**ì‚¬ì „ ìš”êµ¬ì‚¬í•­:**
- NFT ì†Œìœ ìì—¬ì•¼ í•¨
- ê±°ë˜ì†Œ ì»¨íŠ¸ë™íŠ¸ì— NFT ì „ì†¡ ìŠ¹ì¸ í•„ìš”
- íŒë§¤ ê°€ê²©ì´ 0ë³´ë‹¤ ì»¤ì•¼ í•¨

### ê±°ë˜ ìŠ¹ì¸ ì„¤ì •

```typescript
// í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê±°ë˜ ìƒì„± ì „ ìŠ¹ì¸ ì„¤ì •
async function approveNFTForExchange(tokenId: string) {
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  const signer = provider.getSigner();
  
  const nftContract = new ethers.Contract(nftAddress, nftABI, signer);
  
  const tx = await nftContract.approve(exchangeAddress, tokenId);
  await tx.wait();
  
  console.log('NFT approved for exchange');
}
```

---

## ğŸ’° NFT êµ¬ë§¤ ë° ê²°ì œ

### NFT êµ¬ë§¤ (buyNFT)

```solidity
function buyNFT(uint256 tradeId) external nonReentrant {
    Trade storage trade = trades[tradeId];
    require(trade.isActive, "ToreExchange: Trade is not active");
    require(trade.seller != msg.sender, "ToreExchange: Cannot buy your own NFT");
    require(toreTokenContract.balanceOf(msg.sender) >= trade.price, "ToreExchange: Insufficient TORE balance");
    
    trade.isActive = false;
    trade.buyer = msg.sender;
    trade.completedAt = block.timestamp;
    
    uint256 fee = (trade.price * feePercentage) / FEE_DENOMINATOR;
    uint256 sellerAmount = trade.price - fee;
    
    require(toreTokenContract.transferFrom(msg.sender, trade.seller, sellerAmount), "ToreExchange: TORE transfer failed");
    if (fee > 0) {
        require(toreTokenContract.transferFrom(msg.sender, owner(), fee), "ToreExchange: Fee transfer failed");
    }
    
    nftContract.transferFrom(trade.seller, msg.sender, trade.tokenId);
    
    userTrades[msg.sender].push(tradeId);
    
    emit TradeCompleted(tradeId, msg.sender, trade.price);
}
```

**ì‹¤í–‰ íë¦„:**
1. **ê±°ë˜ ìƒíƒœ í™•ì¸**: ê±°ë˜ê°€ í™œì„± ìƒíƒœì¸ì§€ í™•ì¸
2. **ìê¸° ê±°ë˜ ë°©ì§€**: ìì‹ ì˜ NFTë¥¼ êµ¬ë§¤í•  ìˆ˜ ì—†ìŒ
3. **ì”ì•¡ í™•ì¸**: êµ¬ë§¤ìê°€ ì¶©ë¶„í•œ TORE í† í°ì„ ë³´ìœ í•˜ëŠ”ì§€ í™•ì¸
4. **ê±°ë˜ ìƒíƒœ ì—…ë°ì´íŠ¸**: ê±°ë˜ë¥¼ ë¹„í™œì„±í™”í•˜ê³  êµ¬ë§¤ì ì •ë³´ ì €ì¥
5. **ìˆ˜ìˆ˜ë£Œ ê³„ì‚°**: ê±°ë˜ ìˆ˜ìˆ˜ë£Œ ê³„ì‚° (ê¸°ë³¸ 2.5%)
6. **í† í° ì „ì†¡**: íŒë§¤ìì—ê²Œ í† í° ì „ì†¡, ì†Œìœ ìì—ê²Œ ìˆ˜ìˆ˜ë£Œ ì „ì†¡
7. **NFT ì „ì†¡**: NFT ì†Œìœ ê¶Œì„ êµ¬ë§¤ìì—ê²Œ ì´ì „
8. **ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸**: êµ¬ë§¤ìì˜ ê±°ë˜ ëª©ë¡ì— ì¶”ê°€
9. **ì´ë²¤íŠ¸ ë°œìƒ**: ê±°ë˜ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œìƒ

### ìˆ˜ìˆ˜ë£Œ ê³„ì‚° ì˜ˆì‹œ

```solidity
uint256 price = 1000 * 10**18;  // 1000 TORE
uint256 feePercentage = 250;    // 2.5%
uint256 fee = (price * feePercentage) / FEE_DENOMINATOR;
// fee = (1000 * 10**18 * 250) / 10000 = 25 * 10**18 (25 TORE)

uint256 sellerAmount = price - fee;
// sellerAmount = 1000 * 10**18 - 25 * 10**18 = 975 * 10**18 (975 TORE)
```

### êµ¬ë§¤ ì „ ìŠ¹ì¸ ì„¤ì •

```typescript
// êµ¬ë§¤ìê°€ ê±°ë˜ì†Œì— TORE í† í° ì „ì†¡ ìŠ¹ì¸
async function approveToreForExchange(amount: string) {
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  const signer = provider.getSigner();
  
  const toreTokenContract = new ethers.Contract(toreTokenAddress, toreTokenABI, signer);
  
  const amountWei = ethers.utils.parseEther(amount);
  const tx = await toreTokenContract.approve(exchangeAddress, amountWei);
  await tx.wait();
  
  console.log('TORE tokens approved for exchange');
}
```

---

## âŒ ê±°ë˜ ì·¨ì†Œ ë° ê´€ë¦¬

### ê±°ë˜ ì·¨ì†Œ (cancelTrade)

```solidity
function cancelTrade(uint256 tradeId) external {
    Trade storage trade = trades[tradeId];
    require(trade.isActive, "ToreExchange: Trade is not active");
    require(trade.seller == msg.sender, "ToreExchange: Only seller can cancel trade");
    
    trade.isActive = false;
    
    emit TradeCancelled(tradeId);
}
```

**ì‹¤í–‰ íë¦„:**
1. **ê±°ë˜ ìƒíƒœ í™•ì¸**: ê±°ë˜ê°€ í™œì„± ìƒíƒœì¸ì§€ í™•ì¸
2. **ê¶Œí•œ í™•ì¸**: í˜¸ì¶œìê°€ íŒë§¤ìì¸ì§€ í™•ì¸
3. **ê±°ë˜ ë¹„í™œì„±í™”**: ê±°ë˜ë¥¼ ë¹„í™œì„±í™”
4. **ì´ë²¤íŠ¸ ë°œìƒ**: ê±°ë˜ ì·¨ì†Œ ì´ë²¤íŠ¸ ë°œìƒ

**ì·¨ì†Œ ê°€ëŠ¥ ì¡°ê±´:**
- ê±°ë˜ê°€ í™œì„± ìƒíƒœì—¬ì•¼ í•¨
- íŒë§¤ìë§Œ ì·¨ì†Œ ê°€ëŠ¥
- êµ¬ë§¤ìê°€ ì—†ëŠ” ìƒíƒœ

### ê±°ë˜ ê´€ë¦¬ í•¨ìˆ˜

```solidity
function getTrade(uint256 tradeId) external view returns (Trade memory) {
    return trades[tradeId];
}

function getUserTrades(address user) external view returns (uint256[] memory) {
    return userTrades[user];
}

function getActiveTrades(uint256 offset, uint256 limit) external view returns (uint256[] memory) {
    uint256[] memory activeTrades = new uint256[](limit);
    uint256 count = 0;
    
    for (uint256 i = offset; i < _tradeIdCounter && count < limit; i++) {
        if (trades[i].isActive) {
            activeTrades[count] = i;
            count++;
        }
    }
    
    uint256[] memory result = new uint256[](count);
    for (uint256 i = 0; i < count; i++) {
        result[i] = activeTrades[i];
    }
    
    return result;
}
```

---

## ğŸ’¸ ìˆ˜ìˆ˜ë£Œ ì‹œìŠ¤í…œ

### ìˆ˜ìˆ˜ë£Œ ì„¤ì •

```solidity
function updateFee(uint256 newFeePercentage) external onlyOwner {
    require(newFeePercentage <= 1000, "ToreExchange: Fee cannot exceed 10%");
    feePercentage = newFeePercentage;
    emit FeeUpdated(newFeePercentage);
}
```

**ìˆ˜ìˆ˜ë£Œ íŠ¹ì§•:**
- **ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ**: 2.5% (250/10000)
- **ìµœëŒ€ ìˆ˜ìˆ˜ë£Œ**: 10% (1000/10000)
- **ì†Œìœ ìë§Œ ë³€ê²½ ê°€ëŠ¥**: ë³´ì•ˆì„ ìœ„í•´ ì†Œìœ ìë§Œ ìˆ˜ì • ê°€ëŠ¥
- **íˆ¬ëª…ì„±**: ëª¨ë“  ìˆ˜ìˆ˜ë£Œê°€ ë¸”ë¡ì²´ì¸ì— ê¸°ë¡

### ìˆ˜ìˆ˜ë£Œ ë¶„ë°°

```solidity
uint256 fee = (trade.price * feePercentage) / FEE_DENOMINATOR;
uint256 sellerAmount = trade.price - fee;

// íŒë§¤ìì—ê²Œ í† í° ì „ì†¡
require(toreTokenContract.transferFrom(msg.sender, trade.seller, sellerAmount), "ToreExchange: TORE transfer failed");

// ì†Œìœ ìì—ê²Œ ìˆ˜ìˆ˜ë£Œ ì „ì†¡
if (fee > 0) {
    require(toreTokenContract.transferFrom(msg.sender, owner(), fee), "ToreExchange: Fee transfer failed");
}
```

**ìˆ˜ìˆ˜ë£Œ ë¶„ë°° ì˜ˆì‹œ:**
- **ê±°ë˜ ê°€ê²©**: 1000 TORE
- **ìˆ˜ìˆ˜ë£Œ**: 25 TORE (2.5%)
- **íŒë§¤ì ìˆ˜ë ¹**: 975 TORE
- **ê±°ë˜ì†Œ ìˆ˜ë ¹**: 25 TORE

---

## ğŸ–¥ ë°±ì—”ë“œ API êµ¬í˜„

### ê±°ë˜ì†Œ ì»¨íŠ¸ë¡¤ëŸ¬

```typescript
// src/controllers/exchangeController.ts
export async function createTrade(req: Request, res: Response) {
  try {
    const { tokenId, price } = req.body;
    
    if (!tokenId || isNaN(parseInt(tokenId)) || parseInt(tokenId) < 0) {
      return res.status(400).json({
        success: false,
        error: 'Invalid token ID'
      });
    }
    
    if (!price || isNaN(parseFloat(price)) || parseFloat(price) <= 0) {
      return res.status(400).json({
        success: false,
        error: 'Invalid price'
      });
    }
    
    const exchangeAddress = process.env.TORE_EXCHANGE_ADDRESS;
    if (!exchangeAddress) {
      return res.status(500).json({
        success: false,
        error: 'Exchange contract address not configured'
      });
    }
    
    const tradeId = Math.floor(Math.random() * 1000000) + 1;
    
    res.json({
      success: true,
      data: {
        tradeId,
        tokenId: parseInt(tokenId),
        price: parseFloat(price),
        message: 'Trade created successfully. Please confirm the transaction in MetaMask.'
      }
    });
  } catch (error) {
    console.error('[Exchange Controller] Create trade error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to create trade'
    });
  }
}
```

### ê±°ë˜ ì¡°íšŒ API

```typescript
export async function getActiveTrades(req: Request, res: Response) {
  try {
    const { offset = '0', limit = '20' } = req.query;
    
    const offsetNum = parseInt(offset as string);
    const limitNum = parseInt(limit as string);
    
    if (isNaN(offsetNum) || offsetNum < 0) {
      return res.status(400).json({
        success: false,
        error: 'Invalid offset parameter'
      });
    }
    
    if (isNaN(limitNum) || limitNum <= 0 || limitNum > 100) {
      return res.status(400).json({
        success: false,
        error: 'Invalid limit parameter (must be between 1 and 100)'
      });
    }
    
    const exchangeAddress = process.env.TORE_EXCHANGE_ADDRESS;
    if (!exchangeAddress) {
      return res.status(500).json({
        success: false,
        error: 'Exchange contract address not configured'
      });
    }
    
    const activeTrades = [
      {
        tradeId: 1,
        seller: '0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6',
        tokenId: 1,
        price: '100.0',
        createdAt: Date.now() - 86400000
      },
      {
        tradeId: 3,
        seller: '0x1234567890123456789012345678901234567890',
        tokenId: 3,
        price: '150.0',
        createdAt: Date.now() - 43200000
      }
    ];
    
    res.json({
      success: true,
      data: {
        trades: activeTrades,
        count: activeTrades.length,
        offset: offsetNum,
        limit: limitNum
      }
    });
  } catch (error) {
    console.error('[Exchange Controller] Get active trades error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to get active trades'
    });
  }
}
```

### ê±°ë˜ì†Œ ë¼ìš°í„°

```typescript
// src/routes/exchange.ts
router.post('/create-trade', createTrade);
router.post('/buy-nft', buyNFT);
router.post('/cancel-trade', cancelTrade);
router.get('/trade/:tradeId', getTrade);
router.get('/user-trades/:address', getUserTrades);
router.get('/active-trades', getActiveTrades);
router.get('/stats', getExchangeStats);
```

---

## ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ í†µí•©

### ê±°ë˜ ìƒì„± UI

```html
<!-- ê±°ë˜ ìƒì„± í¼ -->
<div id="createTradeTab" class="tab-content">
    <form id="createTradeForm">
        <div class="form-group">
            <label for="tradeTokenId">NFT í† í° ID</label>
            <input type="number" id="tradeTokenId" placeholder="1" required min="1">
        </div>
        
        <div class="form-group">
            <label for="tradePrice">íŒë§¤ ê°€ê²© (TORE)</label>
            <input type="number" id="tradePrice" placeholder="100" required min="0" step="0.000001">
        </div>
        
        <button type="submit" id="createTradeBtn" class="btn">
            ê±°ë˜ ìƒì„±í•˜ê¸°
        </button>
    </form>
</div>
```

### ê±°ë˜ ìƒì„± JavaScript

```javascript
async function handleCreateTrade(event) {
  event.preventDefault();
  
  const tokenId = document.getElementById('tradeTokenId').value;
  const price = document.getElementById('tradePrice').value;
  
  try {
    showStatus('ê±°ë˜ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...', 'info');
    
    if (!currentAccount) {
      throw new Error('MetaMask ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”');
    }
    
    // NFT ìŠ¹ì¸ í™•ì¸
    const nftContract = new ethers.Contract(nftAddress, nftABI, signer);
    const approvedAddress = await nftContract.getApproved(tokenId);
    
    if (approvedAddress !== exchangeAddress) {
      // NFT ìŠ¹ì¸ í•„ìš”
      const approveTx = await nftContract.approve(exchangeAddress, tokenId);
      await approveTx.wait();
      showStatus('NFT ìŠ¹ì¸ ì™„ë£Œ. ê±°ë˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤...', 'info');
    }
    
    // ê±°ë˜ ìƒì„±
    const exchangeContract = new ethers.Contract(exchangeAddress, exchangeABI, signer);
    const tx = await exchangeContract.createTrade(tokenId, ethers.utils.parseEther(price));
    
    showStatus('íŠ¸ëœì­ì…˜ ì „ì†¡ë¨. í™•ì¸ ëŒ€ê¸° ì¤‘...', 'info');
    
    await tx.wait();
    
    showStatus(`ê±°ë˜ ìƒì„± ì™„ë£Œ! íŠ¸ëœì­ì…˜ í•´ì‹œ: ${tx.hash}`, 'success');
    
    document.getElementById('createTradeForm').reset();
    
  } catch (error) {
    console.error('ê±°ë˜ ìƒì„± ì˜¤ë¥˜:', error);
    showStatus(`ê±°ë˜ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
  }
}
```

### NFT êµ¬ë§¤ UI

```html
<!-- í™œì„± ê±°ë˜ ëª©ë¡ -->
<div id="activeTradesTab" class="tab-content">
    <h3>í™œì„± ê±°ë˜ ëª©ë¡</h3>
    <div id="activeTradesList"></div>
</div>
```

### NFT êµ¬ë§¤ JavaScript

```javascript
async function loadActiveTrades() {
  try {
    const response = await fetch('/api/exchange/active-trades?limit=20');
    const data = await response.json();
    
    if (data.success) {
      displayActiveTrades(data.data.trades);
    } else {
      throw new Error(data.error || 'ê±°ë˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
    }
  } catch (error) {
    console.error('ê±°ë˜ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    showStatus(`ê±°ë˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
  }
}

async function buyNFT(tradeId, price) {
  try {
    showStatus('NFTë¥¼ êµ¬ë§¤í•˜ëŠ” ì¤‘...', 'info');
    
    if (!currentAccount) {
      throw new Error('MetaMask ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”');
    }
    
    // TORE í† í° ìŠ¹ì¸ í™•ì¸
    const toreTokenContract = new ethers.Contract(toreTokenAddress, toreTokenABI, signer);
    const allowance = await toreTokenContract.allowance(currentAccount, exchangeAddress);
    const priceWei = ethers.utils.parseEther(price);
    
    if (allowance.lt(priceWei)) {
      // TORE í† í° ìŠ¹ì¸ í•„ìš”
      const approveTx = await toreTokenContract.approve(exchangeAddress, priceWei);
      await approveTx.wait();
      showStatus('TORE í† í° ìŠ¹ì¸ ì™„ë£Œ. êµ¬ë§¤ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤...', 'info');
    }
    
    // NFT êµ¬ë§¤
    const exchangeContract = new ethers.Contract(exchangeAddress, exchangeABI, signer);
    const tx = await exchangeContract.buyNFT(tradeId);
    
    showStatus('íŠ¸ëœì­ì…˜ ì „ì†¡ë¨. í™•ì¸ ëŒ€ê¸° ì¤‘...', 'info');
    
    await tx.wait();
    
    showStatus(`NFT êµ¬ë§¤ ì™„ë£Œ! íŠ¸ëœì­ì…˜ í•´ì‹œ: ${tx.hash}`, 'success');
    
    // ê±°ë˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    loadActiveTrades();
    
  } catch (error) {
    console.error('NFT êµ¬ë§¤ ì˜¤ë¥˜:', error);
    showStatus(`NFT êµ¬ë§¤ ì‹¤íŒ¨: ${error.message}`, 'error');
  }
}
```

---

## ğŸ”’ ë³´ì•ˆ ë° ìµœì í™”

### ReentrancyGuard

```solidity
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract ToreExchange is Ownable, ReentrancyGuard {
    function buyNFT(uint256 tradeId) external nonReentrant {
        // ê±°ë˜ ë¡œì§
    }
}
```

**ReentrancyGuardì˜ ì—­í• :**
- **ì¬ì§„ì… ê³µê²© ë°©ì§€**: í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ë‹¤ë¥¸ í•¨ìˆ˜ í˜¸ì¶œ ë°©ì§€
- **ì›ìì„± ë³´ì¥**: ê±°ë˜ê°€ ì™„ì „íˆ ì™„ë£Œë˜ê±°ë‚˜ ì™„ì „íˆ ì‹¤íŒ¨
- **ìê¸ˆ ë³´í˜¸**: í† í° ì „ì†¡ ì¤‘ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€

### ì…ë ¥ ê²€ì¦

```solidity
function createTrade(uint256 tokenId, uint256 price) external nonReentrant {
    require(price > 0, "ToreExchange: Price must be greater than 0");
    require(nftContract.ownerOf(tokenId) == msg.sender, "ToreExchange: Not the owner of this NFT");
    require(nftContract.getApproved(tokenId) == address(this) || 
            nftContract.isApprovedForAll(msg.sender, address(this)), 
            "ToreExchange: Contract not approved to transfer NFT");
}
```

**ê²€ì¦ í•­ëª©:**
- **ê°€ê²© ê²€ì¦**: ê°€ê²©ì´ 0ë³´ë‹¤ í°ì§€ í™•ì¸
- **ì†Œìœ ê¶Œ ê²€ì¦**: í˜¸ì¶œìê°€ NFT ì†Œìœ ìì¸ì§€ í™•ì¸
- **ìŠ¹ì¸ ê²€ì¦**: ì»¨íŠ¸ë™íŠ¸ê°€ NFTë¥¼ ì „ì†¡í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸

### ê°€ìŠ¤ ìµœì í™”

```solidity
// íš¨ìœ¨ì ì¸ ë°˜ë³µë¬¸
for (uint256 i = 0; i < recipients.length; i++) {
    require(recipients[i] != address(0), "ToreExchange: Invalid recipient address");
    require(amounts[i] > 0, "ToreExchange: Amount must be greater than 0");
    
    _transfer(msg.sender, recipients[i], amounts[i]);
}
```

**ìµœì í™” ê¸°ë²•:**
- **ë°°ì¹˜ ì²˜ë¦¬**: ì—¬ëŸ¬ ì‘ì—…ì„ í•œ ë²ˆì— ì²˜ë¦¬
- **ìƒíƒœ ë³€ìˆ˜ ìµœì†Œí™”**: í•„ìš”í•œ ìƒíƒœë§Œ ì €ì¥
- **ì´ë²¤íŠ¸ ìµœì í™”**: í•„ìš”í•œ ì •ë³´ë§Œ ì´ë²¤íŠ¸ì— í¬í•¨

---

## ğŸš€ ë°°í¬ ë° ì„¤ì •

### ê±°ë˜ì†Œ ë°°í¬

```bash
# Fuji í…ŒìŠ¤íŠ¸ë„· ë°°í¬
npm run deploy:exchange:fuji

# Avalanche ë©”ì¸ë„· ë°°í¬
npm run deploy:exchange:avalanche
```

### ë°°í¬ ìŠ¤í¬ë¦½íŠ¸

```typescript
// scripts/deployToreExchange.ts
async function main() {
  const [deployer] = await ethers.getSigners();
  
  const nftContractAddress = process.env.NFT_CONTRACT_ADDRESS;
  const toreTokenAddress = process.env.TORE_TOKEN_ADDRESS;
  
  if (!nftContractAddress || !toreTokenAddress) {
    throw new Error("NFT_CONTRACT_ADDRESS and TORE_TOKEN_ADDRESS are required");
  }
  
  const ToreExchange = await ethers.getContractFactory("ToreExchange");
  const contract = await ToreExchange.deploy(nftContractAddress, toreTokenAddress, deployer.address);
  
  await contract.waitForDeployment();
  
  const address = await contract.getAddress();
  console.log("ToreExchange deployed to:", address);
}
```

### í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

```env
# ê±°ë˜ì†Œ ì„¤ì •
TORE_EXCHANGE_ADDRESS=0x...
TORE_EXCHANGE_OWNER=0x...

# ì—°ë™ ì»¨íŠ¸ë™íŠ¸
NFT_CONTRACT_ADDRESS=0x...
TORE_TOKEN_ADDRESS=0x...
```

### ë°°í¬ í›„ ì„¤ì •

```typescript
// ê±°ë˜ì†Œë¥¼ TORE í† í°ì— ì¶”ê°€
await toreToken.addExchangeContract(exchangeAddress);

// ê±°ë˜ì†Œ ìˆ˜ìˆ˜ë£Œ ì„¤ì • (ì„ íƒì‚¬í•­)
await exchange.updateFee(250); // 2.5%
```

---

## ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„

ì´ì œ NFT-TORE ê±°ë˜ì†Œ ì‹œìŠ¤í…œì„ ì´í•´í–ˆìœ¼ë‹ˆ, ë‹¤ìŒ ê°€ì´ë“œì—ì„œëŠ” ì „ì²´ ì‹œìŠ¤í…œì˜ í†µí•© ë° ìµœì í™”ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

**ë‹¤ìŒ ê°€ì´ë“œ**: [ì‹œìŠ¤í…œ í†µí•© ë° ìµœì í™”](./NFT_BLOCKCHAIN_PROJECT_GUIDE_13_ì‹œìŠ¤í…œí†µí•©.md)

---

## ğŸ’¡ í•µì‹¬ ì •ë¦¬

1. **ê±°ë˜ì†ŒëŠ” NFTì™€ TORE í† í° ê°„ì˜ ê±°ë˜ë¥¼ ì¤‘ê°œí•˜ëŠ” í”Œë«í¼ì…ë‹ˆë‹¤.**
2. **ê±°ë˜ ìƒì„±, êµ¬ë§¤, ì·¨ì†Œì˜ ì „ì²´ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.**
3. **ìˆ˜ìˆ˜ë£Œ ì‹œìŠ¤í…œì„ í†µí•´ ê±°ë˜ì†Œ ìš´ì˜ë¹„ë¥¼ í™•ë³´í•©ë‹ˆë‹¤.**
4. **ReentrancyGuardì™€ ì…ë ¥ ê²€ì¦ìœ¼ë¡œ ë³´ì•ˆì„ ê°•í™”í•©ë‹ˆë‹¤.**
5. **ë°±ì—”ë“œ APIì™€ í”„ë¡ íŠ¸ì—”ë“œ UIë¥¼ í†µí•´ ì™„ì „í•œ ê±°ë˜ì†Œ ì‹œìŠ¤í…œì„ ì œê³µí•©ë‹ˆë‹¤.**
